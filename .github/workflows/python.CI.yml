# This workflow will build and push a Python application to an Azure Kubernetes when a commit is pushed to your default branch.

name: Build and deploy Python app to Azure Web App

env:
  AZURE_WEBAPP_NAME: your-app-name  # set this to the name of your Azure Web App
  PYTHON_VERSION: '3.8'              # set this to the Python version to use

on:
  # push:
  #   branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./vote

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      # Optional: Add step to run tests here (PyTest, Django test suites, etc.)

      # - name: Upload artifact for deployment jobs
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: python-app
      #     path: |
      #         .
      #         !venv/
              
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
            
      - name: Login to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }}
        # az acr login --name ${{ secrets.ACR_NAME }} dockerdemoacrname123
  
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          # Point context to the "vote" folder where the Dockerfile lives
          context: ./vote
          push: true
          tags: ${{ secrets.ACR_NAME }}.azurecr.io/vote-app:${{ github.sha }}
      
      # - name: Build Docker Image
      #   run: |
      #     docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/voter-app:${{ github.sha }} .
      
      # - name: Run Trivy vulnerability scanner
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     image-ref: '${{ secrets.ACR_NAME }}.azurecr.io/result-app:${{ github.sha }}'
      #     format: 'table'
      #     exit-code: '1' # This crashes the pipeline if vulnerabilities are found
      #     ignore-unfixed: true
      #     vuln-type: 'os,library'
      #     severity: 'CRITICAL,HIGH'
  
      # # Step 1: Run Trivy and generate SARIF file
      # - name: Run Trivy scanner (SARIF)
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     image-ref: '${{ secrets.ACR_NAME }}.azurecr.io/result-app:${{ github.sha }}'
      #     format: 'sarif'
      #     output: 'trivy-results.sarif'
      #     severity: 'CRITICAL,HIGH'
  
      # # Step 2: Upload the results to GitHub Security tab
      # - name: Upload Trivy scan results to GitHub Security tab
      #   uses: github/codeql-action/upload-sarif@v3
      #   if: always() # Upload results even if the scan found vulnerabilities
      #   with:
      #     sarif_file: 'trivy-results.sarif'
      
      - name: Push to ACR
        # if: success() # Only runs if the scan passes
        run: |
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/vote-app:${{ github.sha }}
          
      - name: Save Tag
        run: |
             echo "${{ github.sha }}" > image_tag.txt
             ls -la image_tag.txt
        
      - name: Upload Tag Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-tag
          path: vote/image_tag.txt
        
  # deploy:
  #   permissions:
  #     contents: none
  #   runs-on: ubuntu-latest
  #   needs: build
  #   environment:
  #     name: 'Development'
  #     url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

  #   steps:
  #     - name: Download artifact from build job
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: python-app
  #         path: .

  #     - name: 'Deploy to Azure Web App'
  #       id: deploy-to-webapp
  #       uses: azure/webapps-deploy@v2
  #       with:
  #         app-name: ${{ env.AZURE_WEBAPP_NAME }}
  #         publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
